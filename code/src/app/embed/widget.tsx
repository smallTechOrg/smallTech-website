"use client";
import { useChat } from "../hooks/useChat";
import { useSearchParams } from "next/navigation";
import { useEffect } from "react";
import { generateColorPalette, applyColorPalette, getThemeColor } from "./colorTheme";
import styles from "./widget.module.css";

export default function Chat() {
  const searchParams = useSearchParams();
  const hostWebsite = searchParams.get("host") || "";
  
  // Initialize color theme
  useEffect(() => {
    const themeColor = getThemeColor(searchParams);
    const palette = generateColorPalette(themeColor);
    applyColorPalette(palette);
  }, [searchParams]);

  const {
    chatBoxText,
    messages,
    input,
    isClient,
    isBotProcessing,
    sendMessage,
    setInput,
  } = useChat(hostWebsite);

  const handleClose = () => {
    // Send close message to parent window
    if (typeof window !== "undefined" && window.parent !== window) {
      window.parent.postMessage({ type: "CLOSE_CHAT" }, "*");
    }
  };

  return (
    <div className={styles.chatContainer}>
      {/* Header */}
      <div className={styles.header}>
        <div className={styles.headerContent}>
          <div className={styles.headerIcon}>
            ðŸ’¬
          </div>
          <div className={styles.headerText}>
            <h1 className={styles.headerTitle}>Chat with us</h1>
            <p className={styles.headerSubtitle}>We typically reply instantly</p>
          </div>
        </div>
        <button 
          className={styles.closeButton}
          onClick={handleClose}
          aria-label="Close chat"
          type="button"
        >
          âœ•
        </button>
      </div>

      {/* Messages Area */}
      <div ref={chatBoxText} className={styles.messagesContainer}>
        {messages.length === 0 && (
          <div className={styles.emptyState}>
            <div className={styles.emptyStateIcon}>ðŸ‘‹</div>
            <h2 className={styles.emptyStateTitle}>Welcome!</h2>
            <p className={styles.emptyStateText}>
              How can we help you today?
            </p>
          </div>
        )}
        
        {messages.map((msg, i) => {
          const isUser = msg.sender === "You";
          const isBot = msg.sender === "Bot";
          
          return (
            <div
              key={i}
              className={`${styles.message} ${
                isUser ? styles.messageUser : styles.messageBot
              }`}
            >
              <div
                className={`${styles.messageAvatar} ${
                  isUser ? styles.messageAvatarUser : styles.messageAvatarBot
                }`}
              >
                {isUser ? "ðŸ‘¤" : "ðŸ¤–"}
              </div>
              <div
                className={`${styles.messageBubble} ${
                  isUser ? styles.messageBubbleUser : styles.messageBubbleBot
                }`}
              >
                <p className={styles.messageText}>{msg.text}</p>
              </div>
            </div>
          );
        })}

        {/* Typing Indicator */}
        {isBotProcessing && (
          <div className={styles.typingIndicator}>
            <div className={`${styles.messageAvatar} ${styles.messageAvatarBot}`}>
              ðŸ¤–
            </div>
            <div className={styles.typingBubble}>
              <span className={styles.typingDot}></span>
              <span className={styles.typingDot}></span>
              <span className={styles.typingDot}></span>
            </div>
          </div>
        )}
      </div>

      {/* Input Area */}
      {isClient && (
        <div className={styles.inputContainer}>
          <form onSubmit={sendMessage} className={styles.inputForm}>
            <div className={styles.inputWrapper}>
              <input
                type="text"
                className={styles.input}
                placeholder="Type your message..."
                value={input}
                onChange={(e) => setInput(e.target.value)}
                disabled={isBotProcessing}
                aria-label="Message input"
              />
            </div>
            <button
              type="submit"
              className={styles.sendButton}
              disabled={isBotProcessing || !input.trim()}
              aria-label="Send message"
            >
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="2"
                strokeLinecap="round"
                strokeLinejoin="round"
              >
                <line x1="22" y1="2" x2="11" y2="13" />
                <polygon points="22 2 15 22 11 13 2 9 22 2" />
              </svg>
            </button>
          </form>
        </div>
      )}
    </div>
  );
}
